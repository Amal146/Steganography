<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="google-signin-client_id"
      content="464751540017-q5653jc1g6jgen7dpg4459bs2ms82ngo.apps.googleusercontent.com"
    />
    <title>Sign Up Page</title>
    <style>.highlight {color: #6f7873; }</style>
    <link rel="stylesheet" href="/static/style.css" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <meta
      name="Cross-Origin-Opener-Policy"
      content="same-origin-allow-popups"
    />
    <style>
      .container {
        text-align: center;
      }

      .icon-container {
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1><span class="highlight">P</span>ix<span class="highlight">H</span>ide</h1>
      <h2>Sign Up</h2>
      <div class="icon-container">
        <div
          id="g_id_onload"
          data-client_id="464751540017-q5653jc1g6jgen7dpg4459bs2ms82ngo.apps.googleusercontent.com"
          data-context="signin"
          data-ux_mode="popup"
          data-callback="handleCredentialResponse"
          data-auto_prompt="false"
        ></div>
      </div>

      <div class="icon-container">
        <div
          class="g_id_signin"
          data-type="icon"
          data-shape="square"
          data-theme="filled_blue"
          data-text="signin_with"
          data-size="large"
        ></div>
      </div>
      <h3>or</h3>
      <form id="signupForm" action="/signup" method="post">
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" name="username" required />
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" name="password" required />
        </div>
        <button type="submit" id="sign">Sign Up</button>
        <script>
          document
            .getElementById("signupForm")
            .addEventListener("submit", async function (event) {
              event.preventDefault();
              const form = event.target;
              const formData = new FormData(form);

              try {
                const response = await fetch("/signup", {
                  method: "POST",
                  body: formData,
                });

                if (response.ok) {
                  // Redirect the user to the welcome page
                  var username = document.getElementById("username").value;
                  window.location.href = "/welcome?username=" + encodeURIComponent(username);
                } else {
                  // Handle errors
                  var errorMessage = "Username already exists";
                  document.getElementById("error-msg").innerText = errorMessage;
                }
              } catch (error) {
                console.error("Error:", error);
                var errorMessage = "An error occured Try later";
                document.getElementById("error-msg").innerText = errorMessage;
              }
            });
        </script>
      </form>
      <h3>Do have an account ? <a id="s" href="#"> Login </a></h3>
      <script>
        document.getElementById("s").addEventListener("click", function () {
          window.location.href = "/";
        });
      </script>
      <p id="error-msg"></p>
      <script src="https://accounts.google.com/gsi/client" async defer></script>
      <script>
        function handleCredentialResponse(response) {
          const responsePayload = decodeJwtResponse(response.credential);
          console.log("Given Name: " + responsePayload.given_name);
          var username = responsePayload.given_name; // Assuming the username is included in the JWT payload
          if (username) {
            // Redirect to welcome page with username as query parameter
            window.location.href =
              "/welcome?username=" + encodeURIComponent(username);
          } else {
            console.error("Username not found in JWT payload.");
            var errorMessage = "Username not found in JWT payload.";
            document.getElementById("error-msg").innerText = errorMessage;
          }
        }

        function decodeJwtResponse(token) {
          var base64Url = token.split(".")[1];
          var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          var jsonPayload = decodeURIComponent(
            window
              .atob(base64)
              .split("")
              .map(function (c) {
                return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
              })
              .join("")
          );

          return JSON.parse(jsonPayload);
        }
      </script>
    </div>
  </body>
</html>
